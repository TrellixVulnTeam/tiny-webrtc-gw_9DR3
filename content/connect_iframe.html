<html>
<body onload='connectIFrameOnLoad(this)'>
<select id='joinMode' name='joinMode' style='display:none;' onchange='onJoinModeChange(this)'>
  <option value='broadcast'>broadcast</option>
  <option value='watch'>watch</option>
</select>
<select id='selectUser' name='selectUser' style='display:none;' onchange='onSelectUserChange(this)'>
</select>
<button id='joinButton' onClick='onOK(this)'>
Join
</button>
<button id='leaveButton' onClick='onLeave(this)'>
Leave Room
</button>
</body>

<script src='src/js/adapter.js'></script>
<script src='src/js/lib/ga.js'></script>
<script src='js/popup.js'></script>
<script src='js/peers.js'></script>
<script src='js/peerdynamic.js'></script>
<script src='js/broadcast.js'></script>
<script language='javascript'>

function connectIFrameOnLoad(htmlBodyElem)
{
    console.debug('connectIFrameOnLoad');

    window.parent.connectIframe = window;
    
    if(window.parent.iframeConnectState.selectedRoom)
    {
        leaveButton.disabled = false;
        window.parent.document.getElementById('roomName').disabled = true;
        document.getElementById('selectUser').style.cssText = '';
        document.getElementById('joinButton').innerHTML = 'Watch';
    }
    else
    {
        window.parent.document.getElementById('roomName').disabled = false;
        document.getElementById('selectUser').style.cssText = 'display:none';
        document.getElementById('joinButton').innerHTML = 'Join Room';
    }

    let selectUser = window.document.getElementById('selectUser');
    for(let p = 0; p < peerList.length; p++)  {
        if(peerList[p]['recvonly']) continue;

        var name = peerList[p]['name'];

        let option = document.createElement('option');
        option.value = name;
        option.text = name;
        selectUser.options.add(option);
        window.parent.iframeConnectState.selectedUser = name;
    }
}

function onJoin() {
  var parentDoc = window.parent.document;
  var joinMode = document.getElementById('joinMode');
  var roomElem = parentDoc.getElementById('roomName');
  if(roomElem.value.length == 0) { alert('enter a room name'); return; }

  if(window.parent.iframeConnectState.selectedRoom)
  {
    joinMode.value = 'watch';
  }
  else
  {
    joinMode.value = 'broadcast';
    window.parent.iframeConnectState.selectedRoom = roomElem.value;
    window.location.reload();
  }

  var vidElem = joinMode.value == 'broadcast' ?
    parentDoc.getElementById('localVideo') :
    parentDoc.getElementById('videoMain');
  var vidElemButton = parentDoc.getElementById(vidElem.id == 'videoMain' ? 'videoMainButton' : 'localVideoButton')

  var f = function() {
    joinIframeOnLoadBroadcast(joinMode);
  }

  connectVideoIframe(vidElem, f, vidElem.value);
}

function onOK(okButton) {
  onJoin();
}

function onLeave(leaveButton)
{
  leaveButton.disabled = true;
  window.parent.iframeConnectState.selectedRoom = null;
  window.parent.iframeConnectState.selectedUser = null;
  window.parent.onLeave();
  window.location.reload();
}

function onSelectUserChange(elem)
{
  window.parent.iframeConnectState.selectedUser = elem.value;
}

function onJoinModeChange(elem)
{
  var selectUser = document.getElementById('selectUser');
  selectUser.style.cssText = 'display:none;';
  if(elem.value == 'watch')
  {
    selectUser.style.cssText = '';
  }
}
</script>

</html>

